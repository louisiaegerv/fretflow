<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FretFlow</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
         /* Base Styles for the Component */
        :root {
            --glow-color: #00ff37; /* Existing blue glow for CAGED */
            --on-text: #cacaca;
            --off-text: #444;
            --off-light: #3a3a3a;
            --amp-bg: #1a1a1a;
            --panel-bg: #404040;

            /* New colors for the green mode buttons */
            --mode-off-bg: #3c5e3d; /* Darker green for inactive state */
            --mode-off-border: #4a754b;
            --mode-on-bg: #32cd32; /* Lime Green for active state */
            --mode-on-border: #2bad2b;
            --mode-on-text: #ffffff; /* White text for active state */
        }
        
        /* Hide the actual inputs - essential for functionality */
        .hidden-checkbox, .hidden-radio {
            display: none;
        }

        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Style for the fret lines */
        .fret {
            border-right: 2px solid #555;
        }
        
        /* Style for the 'nut' (fret 0) */
        .fret-0 {
            border-right: 6px solid #ccc;
        }

        /* Style for the strings */
        .string-line {
            height: 1px;
            background-color: #777;
            position: absolute;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        
        /* Sizing for strings to get thinner from low E to high E */
        .string-line-0 { height: 3px; } /* High E */
        .string-line-1 { height: 3px; }
        .string-line-2 { height: 4px; }
        .string-line-3 { height: 4px; }
        .string-line-4 { height: 5px; }
        .string-line-5 { height: 5px; } /* Low E */
        
        /* Style for the note dots */
        .note-dot {
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            transition: all 0.15s ease-in-out;
            font-size: 0.9rem; /* Added for note names */
            box-sizing: border-box; /* Ensures border doesn't add to size */
        }
        
        /* Note dot colors */
        .dot-primary {
            border: 3px solid #51b0fd; 
            background-color: #2e578b; 
            opacity: 1;
        }
        .dot-dimmed {
            background-color: #374151; /* gray-700 */
            opacity: 0.2;
        }
        .dot-highlight {
            border: 3px solid #27b45b; 
            background-color: #186b37; /* green-500 */
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Root note style (border) */
        .dot-root {
            border: 3px solid #fde047; /* yellow-300 */
            background-color: #71774e;
            box-shadow: 0 0 10px #fde047;
        }
        
        /* Triad note style */
        .dot-triad {
            border: 3px solid #da70d6; /* violet */
            background-color: #8a4b8a;
            box-shadow: 0 0 8px #da70d6;
        }

        .dot-root.dot-triad {
            box-shadow: 0 0 8px #da70d6, 0px 0px 0px 5px #fde047;
        }
        
        /* Fret marker styles: Moved to standard inlay positions */
        .fret-marker {
            position: absolute;
            left: 50%;
            width: 10px;
            height: 10px;
            background-color: #6b7280; /* gray-500 */
            border-radius: 50%;
            z-index: 0;
            /* Centered between G and D strings (12rem from top) */
            top: 12rem; 
            transform: translate(-50%, -50%);
        }
        
        .fret-marker-12, .fret-marker-24 {
            /* First dot (between B and G strings, 8rem from top) */
            top: 8rem;
        }
        .fret-marker-12::after, .fret-marker-24::after {
            content: '';
            position: absolute;
            left: 50%;
            width: 10px;
            height: 10px;
            background-color: #6b7280;
            border-radius: 50%;
            /* Second dot (between D and A strings, 8rem below first dot -> 16rem from top) */
            top: 8rem; 
            transform: translate(-50%, 0);
        }
        /* --- END CHANGE --- */


        /* Custom scrollbar for the fretboard */
        .fretboard-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .fretboard-scroll::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
            border-radius: 10px;
        }
        .fretboard-scroll::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
        }
        .fretboard-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

        #caged-select-controls label {
            display: flex;
            width: 50px;
            height: 50px;
            justify-content: center; 
            align-items: center; 
            border-radius: 100%;
            cursor: pointer;
            font-weight: 700;
            border-width: 2px;
        }

        .label-no-caret {
            caret-color: transparent;
            user-select: none;
        }


        .amp-control-container {
            caret-color: transparent;
            user-select: none;
            /* padding: 20px; */
            /* background-color: #554433; 
            background-color: #2c2a3f; 
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            caret-color: transparent;
            user-select: none; */
        }

        /* Hide the actual checkbox */
        .hidden-checkbox {
            display: none;
        }

        /* Base Switch Styling */
        .amp-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 250px; /* Adjust as needed */
            height: 40px;
            border-radius: 20px;
            padding: 0 5px;
            cursor: pointer;
            background-color: var(--amp-bg);
            border: 3px solid #222;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 1.0), 0 0 0 1px #353535; 
            transition: background-color 0.3s ease;
        }

        /* Text Styling */
        .switch-text {
            color: #747474; /* Default dark/off text color */
            font-size: 1.2em;
            font-weight: bold;
            letter-spacing: 1px;
            margin-left: 10px;
            text-shadow: none;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        /* Indicator Light Styling (Off State) */
        .indicator-light {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 50%;
            background-color: #3a3a3a; 
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid #222;
        }

        /* -------------------------------------- */
        /* Checked State (ON) STYLES */
        /* -------------------------------------- */

        /* Target the switch (label) when the hidden checkbox is checked */
        .hidden-checkbox:checked + .amp-switch {
            /* Optional: Slight background change for 'active' feel */
            background-color: #0d0d0d;
        }

        /* Change Text Color and Apply Glow */
        .hidden-checkbox:checked + .amp-switch .switch-text {
            color: var(--on-text);
            /*text-shadow: 
                0 0 2px #b6b6b6, 
                0 0 10px #a5a5a5, 
                0 0 20px rgba(238, 238, 238, 0.5); */
        }

        /* Change Indicator Light Color and Apply Glow */
        .hidden-checkbox:checked + .amp-switch .indicator-light {
            background-color: #00ffff; /* Bright center */
            box-shadow: 
                0 0 8px 0px #00ffff, /* Stronger inner glow */
                0 0 15px rgba(0, 255, 255, 0.7), /* Medium glow */
                0 0 25px rgba(0, 255, 255, 0.4); /* Fainter outer halo */
            border-color: #008888;
        }
        
        /* Change Indicator Light Color and Apply Glow */
        .hidden-checkbox:checked + .amp-switch .indicator-light.green {
            background-color: var(--glow-color); /* Bright center */
            box-shadow: 
                0 0 8px 0px var(--glow-color), /* Stronger inner glow */
                0 0 15px rgba(0, 255, 34, 0.7), /* Medium glow */
                0 0 25px rgba(0, 255, 136, 0.4); /* Fainter outer halo */
            border-color: #008834;
        }
        
        .select-wrapper {
            /* Required to position the select element relative to the wrapper */
            position: relative; 
            /* The wrapper should match the width/height of the select */
            width: 100%; 
            /* Set the desired height */
            height: 40px; 
        }

        /* Key Select dropdown input styling */
        select#key-select {
            font-size: 1.2em;
            width: 100%;
            border-radius: 25px;
            padding-left: 15px; /* Adjust as needed for text to not overlap arrow */
            /* Padding right should be set to account for the custom caret area */
            padding-right: 35px; /* Ensure enough space for the custom caret */
            height: 40px;
            background-color: var(--amp-bg);
            border: 3px solid #222;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 1.0), 0 0 0 1px #353535; 
            padding-right: 8px;
            cursor: pointer;

            /* 3. Hide the native dropdown arrow in various browsers */
            -webkit-appearance: none; /* Chrome, Safari, Opera */
            -moz-appearance: none;    /* Firefox */
            appearance: none;         /* Standard */
        }

        /* 4. Add the custom SVG caret using background properties */
        select#key-select {
            /* Use the SVG Data URI as a background image */
            background-image: var(--custom-caret-svg);
            
            /* Center the background image vertically */
            background-position: right 15px center; /* <-- THIS CONTROLS PADDING */
            
            /* Do not repeat the background image */
            background-repeat: no-repeat;
            
            /* Size the background image (the caret) */
            background-size: 20px 20px; /* Adjust size as needed */
            
            /* Additional background color from your original style (if needed) */
            background-color: var(--amp-bg);
        }

        /* Define the SVG in a variable for cleaner code, as per step 2 */
        :root {
            --custom-caret-svg: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='none' stroke='white' stroke-width='2' d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
        }

        
        /* Base Styling for each Mode Switch (Label) */
        .mode-switch {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space text and light */
            width: 250px; /* Adjust as needed */
            height: 40px;
            border-radius: 25px; /* Fully rounded */
            padding: 0 8px;
            cursor: pointer;
            background-color: var(--amp-bg);
            border: 3px solid #222;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 1.0), 0 0 0 1px #353535; 
            transition: all 0.3s ease;
        }
        
        /* Radio Text (Off State) */
        .mode-text {
            color: var(--off-text); 
            font-size: 1.2rem; /* Match CAGED size */
            font-weight: 900;
            letter-spacing: 3px;
            margin-left: 10px;
            text-transform: uppercase;
            text-shadow: none;
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }

        /* Indicator Light Styling (Off State - Reusing .indicator-light styles) */
        .mode-indicator-light {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 50%;
            background-color: var(--off-light);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.9);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid #222;
            margin-right: 5px;
        }

        /* RADIO CHECKED STATE (ON) */
        .hidden-radio:checked + .mode-switch {
            /* No change to background, glow comes from text/light */
            /* border-color: var(--border-color);  */
            background-color: #0d0d0d;
        }

        /* Radio Text (On State) */
        .hidden-radio:checked + .mode-switch .mode-text {
            color: var(--on-text); 
        }

        /* Radio Indicator Light (On State) */
        .hidden-radio:checked + .mode-switch .mode-indicator-light {
            background-color: var(--glow-color);
            box-shadow: 
                0 0 10px var(--glow-color), 
                0 0 20px rgba(0, 240, 255, 0.8), 
                0 0 40px rgba(0, 240, 255, 0.5); 
            border-color: #008888;
        }

        
 
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class=" p-4">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-white">
            ðŸŽ¸ FretFlow
        </h1>
        <!-- <p class="text-center text-blue-300">
            Connect Pentatonic Scales & the CAGED System
        </p> -->
    </header>

    <!-- Control Panel -->
    <section class="p-4 bg-gray-800 shadow-lg w-full md:max-w-6xl md:mx-auto rounded-lg">
        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <!-- Key Selector -->
            <div class="select-wrapper">
                <label for="key-select" class="block text-sm font-medium text-gray-300 mb-1">Key</label>
                <select id="key-select" class="">
                <!-- <select id="key-select" class="w-full bg-gray-700 border-gray-600 text-white rounded-full shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500"> -->
                    <option value="0">C</option>
                    <option value="1">C# / Db</option>
                    <option value="2">D</option>
                    <option value="3">D# / Eb</option>
                    <option value="4">E</option>
                    <option value="5">F</option>
                    <option value="6">F# / Gb</option>
                    <option value="7">G</option>
                    <option value="8">G# / Ab</option>
                    <option value="9">A</option>
                    <option value="10">A# / Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            
            <!-- New Mode Selector radio buttons -->
            <div class="radio-group-wrapper md:col-span-2">
                <h2 class="control-label">Mode</h2> 
                <div class="radio-group-container flex gap-2">

                    <!-- Major Mode Input/Label -->
                    <input type="radio" id="mode-major" name="music-mode" value="major" class="hidden-radio" checked />
                    <label for="mode-major" class="mode-switch">
                        <span class="mode-text">Major</span>
                        <span class="mode-indicator-light"></span>
                    </label>

                    <!-- Minor Mode Input/Label -->
                    <input type="radio" id="mode-minor" name="music-mode" value="minor" class="hidden-radio" />
                    <label for="mode-minor" class="mode-switch">
                        <span class="mode-text">Minor</span>
                        <span class="mode-indicator-light"></span>
                    </label>
                </div>
            </div>


            <!-- Relative Scale Display -->
            <div class="md:col-span-3 text-center md:text-left space-y-1">
                <p id="relative-scale-display" class="text-sm text-blue-300"></p>
                <p id="pentatonic-notes-display" class="text-sm text-gray-400"></p>
                <p id="diatonic-notes-display" class="text-sm text-gray-400"></p>
            </div>

            <!-- CAGED Shape Selector -->
            <fieldset id="caged-selector-section" class="md:col-span-3">
                <div class="flex flex-wrap gap-4 items-center justify-between">
                    <legend class="block text-sm font-medium text-gray-300 mb-2">CAGED Pentatonic Shape</legend>
                </div>
                
                <div class="flex flex-wrap gap-4" id="caged-select-controls">
                    <div class="inline-flex">
                        <input type="radio" id="shape-all" name="highlight-shape" value="All" class="hidden peer" checked>
                        <label for="shape-all" class="text-lg text-gray-300 border-zinc-600 peer-checked:border-blue-400 peer-checked:text-blue-400 transition-colors label-no-caret">ALL</label>
                    </div>
                    <div class="inline-flex">
                        <input type="radio" id="shape-c" name="highlight-shape" value="C Shape" class="hidden peer">
                        <label for="shape-c" class="text-2xl text-gray-300 border-zinc-600 peer-checked:border-green-600 peer-checked:text-green-600 transition-colors label-no-caret">C</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-a" name="highlight-shape" value="A Shape" class="hidden peer">
                        <label for="shape-a" class="text-2xl text-gray-300 border-zinc-600 peer-checked:border-green-600 peer-checked:text-green-600 transition-colors label-no-caret">A</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-g" name="highlight-shape" value="G Shape" class="hidden peer">
                        <label for="shape-g" class="text-2xl text-gray-300 border-zinc-600 peer-checked:border-green-600 peer-checked:text-green-600 transition-colors label-no-caret">G</label>
                    </div>
                    <div class="inline-flex">
                        <input type="radio" id="shape-e" name="highlight-shape" value="E Shape" class="hidden peer">
                        <label for="shape-e" class="text-2xl text-gray-300 border-zinc-600 peer-checked:border-green-600 peer-checked:text-green-600 transition-colors label-no-caret">E</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-d" name="highlight-shape" value="D Shape" class="hidden peer">
                        <label for="shape-d" class="text-2xl text-gray-300 border-zinc-600 peer-checked:border-green-600 peer-checked:text-green-600 transition-colors label-no-caret">D</label>
                    </div>
                </div>
            </fieldset>

            <!-- Toggle Notes -->
            <div class="amp-control-container">
               <input type="checkbox" id="toggle-notes" class="hidden-checkbox" checked>
               <label for="toggle-notes" class="amp-switch">
                   <span class="switch-text">NOTE NAMES</span>
                   <span class="indicator-light green"></span>
               </label>
           </div>
           
           <!-- Toggle Triad Notes -->
           <div class="amp-control-container">
              <input type="checkbox" id="toggle-triad" class="hidden-checkbox">
              <label for="toggle-triad" class="amp-switch">
                  <span class="switch-text">TRIAD HIGHLIGHT</span>
                  <span class="indicator-light green"></span>
              </label>
          </div>
           
           <!-- Toggle Dim Non-CAGED Notes -->
           <div class="amp-control-container">
              <input type="checkbox" id="triad-focus" class="hidden-checkbox">
              <label for="triad-focus" class="amp-switch">
                  <span class="switch-text">TRIAD FOCUS</span>
                  <span class="indicator-light green"></span>
              </label>
          </div>
           
        </div>
    </section>

    <!-- Fretboard Section -->
    <main class="flex-grow flex flex-col p-4 overflow-hidden">
        <p class="text-center text-gray-400 text-sm mb-2">Scroll fretboard horizontally to explore 
            <span class="inline md:hidden">&rarr;</span>
        </p>
        
        <!-- Fretboard Container -->
        <div id="fretboard-container" class="fretboard-scroll w-full overflow-x-auto bg-gray-800 rounded-lg shadow-inner pl-8 md:max-w-6xl md:mx-auto">
            <!-- Height increased to 24rem (6 * 4rem strings) -->
            <div id="fretboard" class="flex min-w-max h-[24rem] relative">
            <!-- --- END CHANGE --- -->
                <!-- Fretboard will be dynamically generated here -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 p-4 text-center border-t border-gray-700">
        <a href="https://github.com/louisiaegerv/fretflow" target="_blank" class="inline-flex items-center text-blue-300 hover:text-blue-100 transition-colors">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 0C4.477 0 0 4.484 0 10.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.203 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.942.359.31.678.921.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0020 10.017C20 4.484 15.522 0 10 0z" clip-rule="evenodd"></path>
            </svg>
            View on GitHub
        </a>
    </footer>

    <script>
        // --- DATA & CONSTANTS ---

        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        
        // Pentatonic scale intervals (R, 2, 3, 5, 6 for Major | R, m3, 4, 5, m7 for Minor)
        const SCALES = {
            major: [0, 2, 4, 7, 9],
            minor: [0, 3, 5, 7, 10]
        };

        const DIATONIC_SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11], // Major (Ionian)
            minor: [0, 2, 3, 5, 7, 8, 10]  // Natural Minor (Aeolian)
        };

        // Standard Tuning: High E (0) to Low E (5)
        const OPEN_STRINGS = [
            4,  // High E (String 0)
            11, // B (String 1)
            7,  // G (String 2)
            2,  // D (String 3)
            9,  // A (String 4)
            4   // Low E (String 5)
        ];
        
        const FRET_COUNT = 24;
        const FRET_MARKERS = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];

        // --- DOM ELEMENTS ---

        const keySelect = document.getElementById('key-select');
        // const scaleSelect = document.getElementById('scale-select');
        const modeRadios = document.querySelectorAll('input[name="music-mode"]');
        const highlightControls = document.getElementById('caged-select-controls');
        const fretboardDiv = document.getElementById('fretboard');
        const relativeScaleDisplay = document.getElementById('relative-scale-display');
        const pentatonicNotesDisplay = document.getElementById('pentatonic-notes-display');
        const diatonicNotesDisplay = document.getElementById('diatonic-notes-display');
        const notesToggle = document.getElementById('toggle-notes'); // ADDED ()
        let triadToggle = document.getElementById('toggle-triad');
        let triadFocusToggle = document.getElementById('triad-focus');

        // --- STATE ---

        let currentKey = 0;
        let currentScale = 'major';
        let currentHighlight = 'All';
        let currentScaleNotes = [];

        // --- CORE LOGIC ---

        /**
         * Calculates the notes in the currently selected scale.
         */
        function getScaleNotes(rootIndex, scaleType) {
            const intervals = SCALES[scaleType];
            return intervals.map(interval => (rootIndex + interval) % 12);
        }

        /**
         * Updates the text displays for relative, pentatonic, and diatonic scales.
         */
        function updateScaleInfoDisplays() {
            // --- 1. Relative Scale ---
            let relativeNoteIndex;
            let relativeScaleType;
            
            if (currentScale === 'major') {
                relativeNoteIndex = (currentKey + 9) % 12; // Relative minor
                relativeScaleType = 'Minor';
            } else {
                relativeNoteIndex = (currentKey + 3) % 12; // Relative major
                relativeScaleType = 'Major';
            }
            const relativeKeyName = NOTES[relativeNoteIndex].length === 1 ? NOTES[relativeNoteIndex] : `${NOTES[relativeNoteIndex]} / ${NOTES_FLAT[relativeNoteIndex]}`;
            relativeScaleDisplay.textContent = `Relative ${relativeScaleType}: ${relativeKeyName} ${relativeScaleType} Pentatonic`;

            // --- 2. Pentatonic Scale Notes ---
            const pentatonicIntervals = SCALES[currentScale];
            const pentatonicNoteNames = pentatonicIntervals.map(interval => NOTES[(currentKey + interval) % 12]).join(' - ');
            pentatonicNotesDisplay.innerHTML = `<strong>Pentatonic:</strong> ${pentatonicNoteNames}`;

            // --- 3. Diatonic Scale Notes ---
            const diatonicIntervals = DIATONIC_SCALES[currentScale];
            const diatonicNoteNames = diatonicIntervals.map(interval => NOTES[(currentKey + interval) % 12]).join(' - ');
            diatonicNotesDisplay.innerHTML = `<strong>Diatonic:</strong> ${diatonicNoteNames}`;
        }

        /**
         * Checks if a fret is within a given CAGED box range.
         * The ranges repeat every 12 frets.
         */
        function isFretInHighlightRange(fret, range) {
            if (!range) return false;
            
            const [start, end] = range;
            // Check in the primary position
            if (fret >= start && fret <= end) return true;
            // Check one octave up
            if (fret >= start + 12 && fret <= end + 12) return true;
            // Check one octave down
            if (fret >= start - 12 && fret <= end - 12) return true;
            
            return false;
        }

        /**
         * Renders the entire fretboard based on the current state.
         */
        function renderFretboard() {
            // Clear the fretboard
            fretboardDiv.innerHTML = '';
            
            // Calculate scale notes
            currentScaleNotes = getScaleNotes(currentKey, currentScale);
            
            // Get toggle state
            const showNotes = notesToggle.checked; // ADDED ()

            // --- Calculate Highlight Range ---
            // This is the core logic connecting the systems.
            // We base all 5 "boxes" off the Major Key's root on the 6th string.
            
            // 1. Find the Major Key root index
            const majorRootIndex = (currentScale === 'major') ? currentKey : (currentKey + 3) % 12;
            
            // 2. Find the first fret of that root on the 6th (Low E) string
            // (majorRootIndex - LowE_NoteIndex + 12) % 12
            const rootPosEString = (majorRootIndex - OPEN_STRINGS[5] + 12) % 12;

            // 3. Define the 5 boxes (Major Pentatonic shapes) relative to that root position
            // These ranges are the standard "boxes"
            const highlightRanges = {
                // E Shape (Box 1) - e.g., G Maj root at 3, box is [2, 5]
                'E Shape': [rootPosEString - 1, rootPosEString + 2],
                // D Shape (Box 2) - e.g., G Maj root at 3, box is [4, 7]
                'D Shape': [rootPosEString + 1, rootPosEString + 5],
                // C Shape (Box 3) - e.g., G Maj root at 3, box is [7, 9]
                'C Shape': [rootPosEString + 4, rootPosEString + 7],
                // A Shape (Box 4) - e.g., G Maj root at 3, box is [9, 12]
                'A Shape': [rootPosEString + 6, rootPosEString + 10],
                // G Shape (Box 5) - e.g., G Maj root at 3, box is [12, 14]
                'G Shape': [rootPosEString + 9, rootPosEString + 12]
            };

            const currentRange = highlightRanges[currentHighlight];

            // Define triad notes for each CAGED shape (root, third, fifth)
            // These are the intervals relative to the root note of the chord
            const triadIntervals = {
                'E Shape': [0, 4, 7], // Major triad: R, 3, 5
                'D Shape': [0, 4, 7],
                'C Shape': [0, 4, 7],
                'A Shape': [0, 4, 7],
                'G Shape': [0, 4, 7]
            };

            // Get the root note for the current CAGED shape
            let shapeRootIndex;
            if (currentHighlight !== 'All') {
                // For each shape, the root is at a specific position relative to the major root
                switch(currentHighlight) {
                    case 'E Shape':
                        shapeRootIndex = majorRootIndex;
                        break;
                    case 'D Shape':
                        shapeRootIndex = (majorRootIndex + 2) % 12;
                        break;
                    case 'C Shape':
                        shapeRootIndex = (majorRootIndex + 4) % 12;
                        break;
                    case 'A Shape':
                        shapeRootIndex = (majorRootIndex + 5) % 12;
                        break;
                    case 'G Shape':
                        shapeRootIndex = (majorRootIndex + 7) % 12;
                        break;
                }
            }

            // Get triad toggle state
            let showTriad = triadToggle.checked;

            // Get triadFocusToggle state
            let triadFocus = triadFocusToggle.checked;
            if (triadFocus) {
                showTriad = true;
                triadToggle.checked = true;
            }

            // --- Build Frets (Columns) ---
            for (let f = 0; f <= FRET_COUNT; f++) {
                const fretEl = document.createElement('div');
                fretEl.className = 'fret relative flex flex-col justify-around flex-shrink-0';
                
                // Set fret width (nut is narrower)
                if (f === 0) {
                    fretEl.classList.add('fret-0');
                    fretEl.style.width = '1.5rem'; // 24px
                } else {
                    // Frets get slightly narrower up the neck
                    const baseWidth = f < 13 ? 5 : 4.5;
                    fretEl.style.width = `${baseWidth - (f * 0.05)}rem`;
                }
                
                // Add fret markers
                if (FRET_MARKERS.includes(f)) {
                    const markerEl = document.createElement('div');
                    markerEl.className = 'fret-marker';
                    if (f === 12 || f === 24) {
                        markerEl.classList.add('fret-marker-12');
                    }
                    fretEl.appendChild(markerEl);
                }

                // --- Build Strings (Rows) ---
                for (let s = 0; s < 6; s++) {
                    const stringEl = document.createElement('div');
                    stringEl.className = 'relative w-full h-16'; // Each string has 4rem height

                    // Add string line
                    const stringLineEl = document.createElement('div');
                    stringLineEl.className = `string-line string-line-${s}`;
                    stringEl.appendChild(stringLineEl);

                    // --- Calculate and Add Note Dot ---
                    const noteIndex = (OPEN_STRINGS[s] + f) % 12;
                    const isScaleNote = currentScaleNotes.includes(noteIndex);

                    if (isScaleNote) {
                        const noteDotEl = document.createElement('div');
                        noteDotEl.className = 'note-dot';
                        const noteName = NOTES[noteIndex]; // Get the note name
                        
                        const isRootNote = (noteIndex === currentKey);
                        if (isRootNote) {
                            noteDotEl.classList.add('dot-root');
                        }

                        // Check if this note is a triad note for the current shape
                        let isTriadNote = false;
                        // if (showTriad && currentHighlight !== 'All') {
                        if (showTriad) {
                            // For triad notes, we want to highlight the root, 3rd, and 5th of the current key
                            // not the root of the CAGED shape
                            const keyRootIndex = currentKey;
                            // Calculate the interval of this note relative to the key root
                            const interval = (noteIndex - keyRootIndex + 12) % 12;
                            // Check if this interval is in the triad (R, 3, 5)
                            // For minor keys, we need to use a minor triad (R, m3, 5)
                            if (currentScale === 'minor') {
                                // Minor triad: R, m3, 5 (intervals 0, 3, 7)
                                isTriadNote = [0, 3, 7].includes(interval);
                            } else {
                                // Major triad: R, 3, 5 (intervals 0, 4, 7)
                                isTriadNote = [0, 4, 7].includes(interval);
                            }
                        }

                        const isHighlighted = currentHighlight !== 'All' && isFretInHighlightRange(f, currentRange);

                        // Determine the primary style of the dot (highlighted, normal, or dimmed)
                        let dotStyleClass = '';
                        let showNoteName = true; // Assume we show the note name by default

                        if (triadFocus) {
                            // TRIAD FOCUS mode is ON
                            if (isTriadNote) {
                                // It's a triad note, so it should be visible.
                                // Highlight it if it's within the selected CAGED shape.
                                dotStyleClass = isHighlighted ? 'dot-highlight' : 'dot-primary';
                                if (currentHighlight !== 'All' && !isHighlighted) {
                                    // Special case: If a shape is selected but this triad note is outside it,
                                    // treat it like a regular scale note (dot-primary), not a highlighted one.
                                    dotStyleClass = 'dot-dimmed';
                                }
                            } else {
                                // It's NOT a triad note, so it must be dimmed in focus mode.
                                dotStyleClass = 'dot-dimmed';
                                showNoteName = false;
                            }
                        } else {
                            // TRIAD FOCUS mode is OFF (Normal operation)
                            if (currentHighlight === 'All') {
                                // Show all notes normally
                                dotStyleClass = 'dot-primary';
                            } else {
                                // A specific shape is selected
                                if (isHighlighted) {
                                    // Note is inside the selected shape
                                    dotStyleClass = 'dot-highlight';
                                } else {
                                    // Note is outside the selected shape
                                    dotStyleClass = 'dot-dimmed'; // Or 'dot-dimmed' if you prefer to hide non-shape notes completely
                                }
                            }
                        }

                        // Apply the determined style and text
                        if (dotStyleClass) {
                            noteDotEl.classList.add(dotStyleClass);
                            if (showNotes && showNoteName) {
                                noteDotEl.textContent = noteName;
                            }
                        }

                        // Add triad note styling if applicable
                        if (isTriadNote) {
                            noteDotEl.classList.add('dot-triad');
                        }
                        
                        stringEl.appendChild(noteDotEl);
                    }
                    
                    fretEl.appendChild(stringEl);
                }
                
                fretboardDiv.appendChild(fretEl);
            }
        }

        // --- EVENT LISTENERS ---

        function handleControlsChange() {
            currentKey = parseInt(keySelect.value, 10);
            const selectedMode = document.querySelector('input[name="music-mode"]:checked');
            currentScale = selectedMode ? selectedMode.value : 'major'; // Default to 'major' if none is checked
            currentHighlight = document.querySelector('input[name="highlight-shape"]:checked').value;
            
            updateScaleInfoDisplays();
            renderFretboard();
        }

        keySelect.addEventListener('change', handleControlsChange);
        // scaleSelect.addEventListener('change', handleControlsChange);
        modeRadios.forEach(radio => {
            radio.addEventListener('change', handleControlsChange);
        });
        notesToggle.addEventListener('change', handleControlsChange); // ADDED ()
        triadToggle.addEventListener('change', (e) => {
            // If triadToggle is being unchecked, also uncheck triadFocusToggle
            if (!e.target.checked) {
                triadFocusToggle.checked = false;
            }
            handleControlsChange();
        });
        triadFocusToggle.addEventListener('change', (e) => {
            handleControlsChange();
        });
        highlightControls.addEventListener('change', (e) => {
            if (e.target.name === 'highlight-shape') {
                handleControlsChange();
            }
        });

        // --- INITIALIZATION ---
        
        // Add Inter font
        const fontLink = document.createElement('link');
        fontLink.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap';
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);
        
        // Initial render
        handleControlsChange();
        
    </script>

</body>
</html>
