<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FretFlow</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Style for the fret lines */
        .fret {
            border-right: 2px solid #555;
        }
        
        /* Style for the 'nut' (fret 0) */
        .fret-0 {
            border-right: 6px solid #ccc;
        }

        /* Style for the strings */
        .string-line {
            height: 1px;
            background-color: #777;
            position: absolute;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }
        
        /* Sizing for strings to get thinner from low E to high E */
        .string-line-0 { height: 3px; } /* High E */
        .string-line-1 { height: 3px; }
        .string-line-2 { height: 4px; }
        .string-line-3 { height: 4px; }
        .string-line-4 { height: 5px; }
        .string-line-5 { height: 5px; } /* Low E */
        
        /* Style for the note dots */
        .note-dot {
            width: 2rem; /* 32px */
            height: 2rem; /* 32px */
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            transition: all 0.15s ease-in-out;
            font-size: 0.9rem; /* Added for note names */
            box-sizing: border-box; /* Ensures border doesn't add to size */
        }
        
        /* Note dot colors */
        .dot-primary {
            background-color: #3b82f6; /* blue-500 */
            opacity: 1;
        }
        .dot-dimmed {
            background-color: #374151; /* gray-700 */
            opacity: 0.6;
        }
        .dot-highlight {
            background-color: #22c55e; /* green-500 */
            opacity: 1;
            transform: translate(-50%, -50%) scale(1.1);
        }
        
        /* Root note style (border) */
        .dot-root {
            border: 3px solid #fde047; /* yellow-300 */
            box-shadow: 0 0 10px #fde047;
        }
        
        /* Fret marker styles: Moved to standard inlay positions */
        .fret-marker {
            position: absolute;
            left: 50%;
            width: 10px;
            height: 10px;
            background-color: #6b7280; /* gray-500 */
            border-radius: 50%;
            z-index: 0;
            /* Centered between G and D strings (12rem from top) */
            top: 12rem; 
            transform: translate(-50%, -50%);
        }
        
        .fret-marker-12, .fret-marker-24 {
            /* First dot (between B and G strings, 8rem from top) */
            top: 8rem;
        }
        .fret-marker-12::after, .fret-marker-24::after {
            content: '';
            position: absolute;
            left: 50%;
            width: 10px;
            height: 10px;
            background-color: #6b7280;
            border-radius: 50%;
            /* Second dot (between D and A strings, 8rem below first dot -> 16rem from top) */
            top: 8rem; 
            transform: translate(-50%, 0);
        }
        /* --- END CHANGE --- */


        /* Custom scrollbar for the fretboard */
        .fretboard-scroll::-webkit-scrollbar {
            height: 8px;
        }
        .fretboard-scroll::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
            border-radius: 10px;
        }
        .fretboard-scroll::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 10px;
        }
        .fretboard-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }

    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="shadow-sm border-b border-gray-700 p-4">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-white">
            ðŸŽ¸ FretFlow
        </h1>
        <p class="text-center text-blue-300">
            Connect Pentatonic Scales & the CAGED System
        </p>
    </header>

    <!-- Controls -->
    <section class="p-4 bg-gray-800 shadow-lg">
        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <!-- Key Selector -->
            <div>
                <label for="key-select" class="block text-sm font-medium text-gray-300 mb-1">Key</label>
                <select id="key-select" class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="0">C</option>
                    <option value="1">C# / Db</option>
                    <option value="2">D</option>
                    <option value="3">D# / Eb</option>
                    <option value="4">E</option>
                    <option value="5">F</option>
                    <option value="6">F# / Gb</option>
                    <option value="7">G</option>
                    <option value="8">G# / Ab</option>
                    <option value="9">A</option>
                    <option value="10">A# / Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            
            <!-- Scale Selector -->
            <div>
                <label for="scale-select" class="block text-sm font-medium text-gray-300 mb-1">Scale</label>
                <select id="scale-select" class="w-full bg-gray-700 border-gray-600 text-white rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="major">Major Pentatonic</option>
                    <option value="minor">Minor Pentatonic</option>
                </select>
            </div>

            <!-- Relative Scale Display -->
            <div class="md:col-span-3 text-center md:text-left">
                <p id="relative-scale-display" class="text-sm text-blue-300 h-6"></p>
            </div>

            <!-- Highlight Mode -->
            <fieldset class="md:col-span-3">
                <div class="flex flex-wrap gap-4 items-center justify-between">
                    <legend class="block text-sm font-medium text-gray-300 mb-2">Highlight Shape</legend>
                    
                    <!-- --- ADDED --- -->
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="checkbox" id="toggle-notes" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500">
                        <label for="toggle-notes" class="text-sm font-medium text-gray-300">Show Note Names</label>
                    </div>
                    <!-- --- END ADD --- -->
                </div>
                
                <div class="flex flex-wrap gap-2" id="highlight-controls">
                    <div class="inline-flex">
                        <input type="radio" id="shape-all" name="highlight-shape" value="All" class="hidden peer" checked>
                        <label for="shape-all" class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer bg-gray-700 text-gray-300 peer-checked:bg-blue-600 peer-checked:text-white transition-colors">All Notes</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-e" name="highlight-shape" value="E Shape" class="hidden peer">
                        <label for="shape-e" class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer bg-gray-700 text-gray-300 peer-checked:bg-green-600 peer-checked:text-white transition-colors">E Shape</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-d" name="highlight-shape" value="D Shape" class="hidden peer">
                        <label for="shape-d" class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer bg-gray-700 text-gray-300 peer-checked:bg-green-600 peer-checked:text-white transition-colors">D Shape</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-c" name="highlight-shape" value="C Shape" class="hidden peer">
                        <label for="shape-c" class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer bg-gray-700 text-gray-300 peer-checked:bg-green-600 peer-checked:text-white transition-colors">C Shape</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-a" name="highlight-shape" value="A Shape" class="hidden peer">
                        <label for="shape-a" class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer bg-gray-700 text-gray-300 peer-checked:bg-green-600 peer-checked:text-white transition-colors">A Shape</label>
                    </div>
                    
                    <div class="inline-flex">
                        <input type="radio" id="shape-g" name="highlight-shape" value="G Shape" class="hidden peer">
                        <label for="shape-g" class="px-4 py-2 rounded-md text-sm font-medium cursor-pointer bg-gray-700 text-gray-300 peer-checked:bg-green-600 peer-checked:text-white transition-colors">G Shape</label>
                    </div>
                </div>
            </fieldset>

        </div>
    </section>

    <!-- Fretboard Section -->
    <main class="flex-grow flex flex-col p-4 overflow-hidden">
        <p class="text-center text-gray-400 text-sm mb-2">Scroll fretboard horizontally to explore 
            <span class="inline md:hidden">&rarr;</span>
        </p>
        
        <!-- Fretboard Container -->
        <div id="fretboard-container" class="fretboard-scroll w-full overflow-x-auto bg-gray-800 rounded-lg shadow-inner pl-6 md:max-w-6xl md:mx-auto">
            <!-- Height increased to 24rem (6 * 4rem strings) -->
            <div id="fretboard" class="flex min-w-max h-[24rem] relative">
            <!-- --- END CHANGE --- -->
                <!-- Fretboard will be dynamically generated here -->
            </div>
        </div>
    </main>

    <script>
        // --- DATA & CONSTANTS ---

        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const NOTES_FLAT = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        
        // Pentatonic scale intervals (R, 2, 3, 5, 6 for Major | R, m3, 4, 5, m7 for Minor)
        const SCALES = {
            major: [0, 2, 4, 7, 9],
            minor: [0, 3, 5, 7, 10]
        };

        // Standard Tuning: High E (0) to Low E (5)
        const OPEN_STRINGS = [
            4,  // High E (String 0)
            11, // B (String 1)
            7,  // G (String 2)
            2,  // D (String 3)
            9,  // A (String 4)
            4   // Low E (String 5)
        ];
        
        const FRET_COUNT = 24;
        const FRET_MARKERS = [3, 5, 7, 9, 12, 15, 17, 19, 21, 24];

        // --- DOM ELEMENTS ---

        const keySelect = document.getElementById('key-select');
        const scaleSelect = document.getElementById('scale-select');
        const highlightControls = document.getElementById('highlight-controls');
        const fretboardDiv = document.getElementById('fretboard');
        const relativeScaleDisplay = document.getElementById('relative-scale-display');
        const notesToggle = document.getElementById('toggle-notes'); // ADDED ()

        // --- STATE ---

        let currentKey = 0;
        let currentScale = 'major';
        let currentHighlight = 'All';
        let currentScaleNotes = [];

        // --- CORE LOGIC ---

        /**
         * Calculates the notes in the currently selected scale.
         */
        function getScaleNotes(rootIndex, scaleType) {
            const intervals = SCALES[scaleType];
            return intervals.map(interval => (rootIndex + interval) % 12);
        }

        /**
         * Calculates the relative minor/major key.
         */
        function updateRelativeScaleDisplay() {
            let relativeNoteIndex;
            let relativeScaleType;
            
            if (currentScale === 'major') {
                // Relative minor is 3 semitones down (or 9 up)
                relativeNoteIndex = (currentKey + 9) % 12;
                relativeScaleType = 'Minor';
            } else {
                // Relative major is 3 semitones up
                relativeNoteIndex = (currentKey + 3) % 12;
                relativeScaleType = 'Major';
            }
            
            const keyName = NOTES[currentKey].length === 1 ? NOTES[currentKey] : `${NOTES[currentKey]} / ${NOTES_FLAT[currentKey]}`;
            const relativeKeyName = NOTES[relativeNoteIndex].length === 1 ? NOTES[relativeNoteIndex] : `${NOTES[relativeNoteIndex]} / ${NOTES_FLAT[relativeNoteIndex]}`;
            
            relativeScaleDisplay.textContent = `(Same notes as ${relativeKeyName} ${relativeScaleType} Pentatonic)`;
        }

        /**
         * Checks if a fret is within a given CAGED box range.
         * The ranges repeat every 12 frets.
         */
        function isFretInHighlightRange(fret, range) {
            if (!range) return false;
            
            const [start, end] = range;
            // Check in the primary position
            if (fret >= start && fret <= end) return true;
            // Check one octave up
            if (fret >= start + 12 && fret <= end + 12) return true;
            // Check one octave down
            if (fret >= start - 12 && fret <= end - 12) return true;
            
            return false;
        }

        /**
         * Renders the entire fretboard based on the current state.
         */
        function renderFretboard() {
            // Clear the fretboard
            fretboardDiv.innerHTML = '';
            
            // Calculate scale notes
            currentScaleNotes = getScaleNotes(currentKey, currentScale);
            
            // Get toggle state
            const showNotes = notesToggle.checked; // ADDED ()

            // --- Calculate Highlight Range ---
            // This is the core logic connecting the systems.
            // We base all 5 "boxes" off the Major Key's root on the 6th string.
            
            // 1. Find the Major Key root index
            const majorRootIndex = (currentScale === 'major') ? currentKey : (currentKey + 3) % 12;
            
            // 2. Find the first fret of that root on the 6th (Low E) string
            // (majorRootIndex - LowE_NoteIndex + 12) % 12
            const rootPosEString = (majorRootIndex - OPEN_STRINGS[5] + 12) % 12;

            // 3. Define the 5 boxes (Major Pentatonic shapes) relative to that root position
            // These ranges are the standard "boxes"
            const highlightRanges = {
                // E Shape (Box 1) - e.g., G Maj root at 3, box is [2, 5]
                'E Shape': [rootPosEString - 1, rootPosEString + 2],
                // D Shape (Box 2) - e.g., G Maj root at 3, box is [4, 7]
                'D Shape': [rootPosEString + 2, rootPosEString + 4],
                // C Shape (Box 3) - e.g., G Maj root at 3, box is [7, 9]
                'C Shape': [rootPosEString + 4, rootPosEString + 7],
                // A Shape (Box 4) - e.g., G Maj root at 3, box is [9, 12]
                'A Shape': [rootPosEString + 7, rootPosEString + 9],
                // G Shape (Box 5) - e.g., G Maj root at 3, box is [12, 14]
                'G Shape': [rootPosEString + 9, rootPosEString + 12]
            };

            const currentRange = highlightRanges[currentHighlight];

            // --- Build Frets (Columns) ---
            for (let f = 0; f <= FRET_COUNT; f++) {
                const fretEl = document.createElement('div');
                fretEl.className = 'fret relative flex flex-col justify-around flex-shrink-0';
                
                // Set fret width (nut is narrower)
                if (f === 0) {
                    fretEl.classList.add('fret-0');
                    fretEl.style.width = '1.5rem'; // 24px
                } else {
                    // Frets get slightly narrower up the neck
                    const baseWidth = f < 13 ? 5 : 4.5;
                    fretEl.style.width = `${baseWidth - (f * 0.05)}rem`;
                }
                
                // Add fret markers
                if (FRET_MARKERS.includes(f)) {
                    const markerEl = document.createElement('div');
                    markerEl.className = 'fret-marker';
                    if (f === 12 || f === 24) {
                        markerEl.classList.add('fret-marker-12');
                    }
                    fretEl.appendChild(markerEl);
                }

                // --- Build Strings (Rows) ---
                for (let s = 0; s < 6; s++) {
                    const stringEl = document.createElement('div');
                    stringEl.className = 'relative w-full h-16'; // Each string has 4rem height

                    // Add string line
                    const stringLineEl = document.createElement('div');
                    stringLineEl.className = `string-line string-line-${s}`;
                    stringEl.appendChild(stringLineEl);

                    // --- Calculate and Add Note Dot ---
                    const noteIndex = (OPEN_STRINGS[s] + f) % 12;
                    const isScaleNote = currentScaleNotes.includes(noteIndex);

                    if (isScaleNote) {
                        const noteDotEl = document.createElement('div');
                        noteDotEl.className = 'note-dot';
                        const noteName = NOTES[noteIndex]; // Get the note name
                        
                        const isRootNote = (noteIndex === currentKey);
                        if (isRootNote) {
                            noteDotEl.classList.add('dot-root');
                        }

                        // --- LOGIC CHANGED () ---
                        if (currentHighlight === 'All') {
                            noteDotEl.classList.add('dot-primary');
                            // Show note name if toggled
                            if (showNotes) noteDotEl.textContent = noteName;
                        } else {
                            const isHighlighted = isFretInHighlightRange(f, currentRange);
                            if (isHighlighted) {
                                noteDotEl.classList.add('dot-highlight');
                                // Show note name if toggled
                                if (showNotes) noteDotEl.textContent = noteName;
                            } else {
                                noteDotEl.classList.add('dot-dimmed');
                                // Dimmed notes never show the note name
                            }
                        }
                        // --- END CHANGE ---
                        
                        stringEl.appendChild(noteDotEl);
                    }
                    
                    fretEl.appendChild(stringEl);
                }
                
                fretboardDiv.appendChild(fretEl);
            }
        }

        // --- EVENT LISTENERS ---

        function handleControlsChange() {
            currentKey = parseInt(keySelect.value, 10);
            currentScale = scaleSelect.value;
            currentHighlight = document.querySelector('input[name="highlight-shape"]:checked').value;
            
            updateRelativeScaleDisplay();
            renderFretboard();
        }

        keySelect.addEventListener('change', handleControlsChange);
        scaleSelect.addEventListener('change', handleControlsChange);
        notesToggle.addEventListener('change', handleControlsChange); // ADDED ()
        highlightControls.addEventListener('change', (e) => {
            if (e.target.name === 'highlight-shape') {
                handleControlsChange();
            }
        });

        // --- INITIALIZATION ---
        
        // Add Inter font
        const fontLink = document.createElement('link');
        fontLink.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap';
        fontLink.rel = 'stylesheet';
        document.head.appendChild(fontLink);
        
        // Initial render
        handleControlsChange();
        
    </script>

</body>
</html>
